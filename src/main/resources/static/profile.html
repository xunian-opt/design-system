<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¸ªäººä¸­å¿ƒ - è£…ä¿®å…¬å¸ç®¡ç†ç³»ç»Ÿ</title>
  <script src="navbar.js"></script>
  <style>
    /* å¤ç”¨åŸºç¡€æ ·å¼ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; background: #f0f2f5; min-height: 100vh; }
    
    .main-container { padding-top: 10px; }
    .content-card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); max-width: 600px; margin: 0 auto; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; outline: none; transition: all 0.3s; }
    .form-group input:focus { border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24,144,255,0.1); }
    .form-group input:disabled { background-color: #f5f5f5; cursor: not-allowed; color: #999; }
    
    .btn { padding: 10px 24px; background: #1890ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.3s; width: 100%; margin-top: 10px; }
    .btn:hover { background: #40a9ff; }
    
    .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    .avatar-large { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #999; }
    
    .msg { padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; text-align: center; font-size: 14px; }
    .msg.success { background: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; display: block; }
    .msg.error { background: #fff1f0; border: 1px solid #ffccc7; color: #cf1322; display: block; }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="content">
      <div class="content-card">
        <div class="header">
          <div class="avatar-large">ğŸ‘¤</div>
          <h2 id="roleTitle">ç®¡ç†å‘˜èµ„æ–™è®¾ç½®</h2>
        </div>
        <div id="msg" class="msg"></div>
        
        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="username" disabled>
        </div>
        
        <div class="form-group">
          <label>è§’è‰²</label>
          <input type="text" id="role" disabled>
        </div>

        <div class="form-group">
          <label>æ–°å¯†ç </label>
          <input type="password" id="newPass" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
        </div>
        <div class="form-group">
          <label>ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmPass" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
        <button class="btn" onclick="updateProfile()">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/springboot2z04j/users'; 
    let currentUser = {};

    function showMsg(text, type) {
      const el = document.getElementById('msg');
      if (!text) { 
        el.style.display = 'none'; 
        return; 
      }
      el.textContent = text;
      el.className = `msg ${type}`;
      el.style.display = 'block';
      if(type !== 'error') {
          setTimeout(() => el.style.display = 'none', 3000);
      }
    }

    // 1. åˆå§‹åŒ–åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUserInfo() {
      const token = localStorage.getItem('token');
      if (!token) {
        showMsg('æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸ', 'error');
        setTimeout(() => window.location.href = 'index.html', 1500);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/session`, {
          headers: { 'Token': token }
        });
        const d = await res.json();
        
        if (d.code === 0 && d.data) {
          currentUser = d.data;
          document.getElementById('username').value = currentUser.username || '';
          document.getElementById('role').value = currentUser.role || 'ç®¡ç†å‘˜';
          document.getElementById('roleTitle').innerText = `${currentUser.role || 'ç”¨æˆ·'}èµ„æ–™è®¾ç½®`;
        } else {
          showMsg(d.msg || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
        }
      } catch (e) {
        console.error(e);
        showMsg('ç½‘ç»œé”™è¯¯', 'error');
      }
    }

    // 2. æ›´æ–°ä¸ªäººä¿¡æ¯
    async function updateProfile() {
      // --- ä¿®æ”¹ç‚¹ï¼šä¸å†è·å– oldPass ---
      const newPass = document.getElementById('newPass').value.trim();
      const confirmPass = document.getElementById('confirmPass').value.trim();
      
      showMsg(''); 

      // --- ä¿®æ”¹ç‚¹ï¼šç§»é™¤äº†æ—§å¯†ç çš„éç©ºæ ¡éªŒ ---
      
      if (!newPass) {
        showMsg('è¯·è¾“å…¥æ–°å¯†ç ', 'error');
        return;
      }
      if (newPass !== confirmPass) {
        showMsg('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
        return;
      }

      const data = {
        id: currentUser.id,
        username: currentUser.username, 
        password: newPass,
        role: currentUser.role
      };

      try {
        const res = await fetch(`${API_BASE}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Token': localStorage.getItem('token')
          },
          body: JSON.stringify(data)
        });
        
        const d = await res.json();
        
        if (d.code === 0) {
          showMsg('ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
          setTimeout(() => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
          }, 1500);
        } else {
          showMsg(d.msg || 'ä¿®æ”¹å¤±è´¥', 'error');
        }
      } catch (e) {
        console.error(e);
        showMsg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    loadUserInfo();
  </script>
</body>
</html>